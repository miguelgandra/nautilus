% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/processTagData.R
\name{processTagData}
\alias{processTagData}
\title{Process Archival Tag Data}
\usage{
processTagData(
  data,
  downsample.to = 1,
  hard.iron.calibration = TRUE,
  soft.iron.calibration = TRUE,
  orientation.algorithm = "tilt_compass",
  madgwick.beta = 0.02,
  orientation.smoothing = 1,
  correct.pitch.offset = TRUE,
  pitch.warning.threshold = 45,
  roll.warning.threshold = 45,
  dba.window = 3,
  dba.smoothing = 2,
  motion.smoothing = 1,
  depth.smoothing = 10,
  speed.smoothing = 1,
  calculate.paddle.speed = FALSE,
  speed.calibration.values = NULL,
  burst.quantiles = c(0.95, 0.99),
  return.data = TRUE,
  save.files = FALSE,
  output.folder = NULL,
  output.suffix = NULL,
  data.table.threads = NULL,
  verbose = TRUE
)
}
\arguments{
\item{data}{A list of data.tables/data.frames, one for each individual; a single aggregated data.table/data.frame
containing data from multiple animals (with an 'ID' column); or a character vector of file paths pointing to
\code{.rds} files, each containing data for a single individual. When a character vector is provided,
files are loaded sequentially to optimize memory use. The output of the \link{importTagData} function
is strongly recommended, as it formats the data appropriately for all downstream analysis.}

\item{downsample.to}{Numeric. Downsampling frequency in Hz (e.g., 1 for 1 Hz) to reduce data resolution.
Use NULL to retain the original resolution. Defaults to 1.}

\item{hard.iron.calibration}{Logical. Whether to apply hard-iron calibration (offset correction) to magnetometer data.
Default is TRUE.}

\item{soft.iron.calibration}{Logical. Whether to apply soft-iron calibration (scaling and misalignment correction) to magnetometer data.
Default is TRUE.}

\item{orientation.algorithm}{Orientation estimation algorithm:
\itemize{
\item \code{"tilt_compass"} (default): Lightweight 6-axis tilt-compensated compass.
\item \code{"madgwick"}: High-accuracy 9-axis sensor fusion. Requires Python \code{AHRS} module.
}}

\item{madgwick.beta}{Numeric. The Madgwick filter's gain parameter (default: 0.02).
This parameter controls the trade-off between gyroscope and accelerometer measurements.
\itemize{
\item Higher values (e.g., 0.2-0.3) trust the accelerometer more, leading to faster convergence but potentially more noise
.    \item Lower values (e.g., 0.01-0.05) trust the gyroscope more, resulting in smoother but potentially slower convergence
}
Only used when \code{orientation.algorithm = "madgwick"}.}

\item{orientation.smoothing}{Optional. Smoothing window (in seconds) for orientation metrics (roll, pitch, heading).
Uses circular mean. Set to NULL to disable. Default: 1.}

\item{correct.pitch.offset}{A logical value (TRUE/FALSE) indicating whether to apply a pitch
offset correction based on the relationship between pitch angle and vertical speed.
Defaults to FALSE. If TRUE, a linear regression of pitch (in radians) against
\code{vertical_velocity} is performed, and the intercept (pitch at 0 m/s vertical speed)
is subtracted from all pitch estimates. This method is adapted from Kawatsu et al. (2010)
to account for potential tag misalignment.}

\item{pitch.warning.threshold}{Numeric. Threshold (in degrees) for median pitch values that trigger orientation warnings.
Default: 45 (will warn if median |pitch| > 45 degrees).}

\item{roll.warning.threshold}{Numeric. Threshold (in degrees) for median roll values that trigger orientation warnings.
Default: 45 (will warn if median |roll| > 45 degrees).}

\item{dba.window}{Integer. Window size (in seconds) for calculating dynamic body acceleration. Defaults to 3.}

\item{dba.smoothing}{Optional. Smoothing window (in seconds) for VeDBA/ODBA metrics.
Uses arithmetic mean. Set to NULL to disable. Default: 2.}

\item{motion.smoothing}{Optional. Smoothing window (in seconds) for linear motion metrics (surge, sway, heave).
Uses arithmetic mean. Set to NULL to disable. Default: 1.}

\item{depth.smoothing}{Optional. Smoothing window (in seconds) for depth.
Uses arithmetic mean. Set to NULL to disable smoothing (not recommended).
Affects the vertical speed computation, which is based on the central difference of smoothed depth values.
Default: 10 seconds}

\item{speed.smoothing}{Optional. Smoothing window (in seconds) applied to derived speed or velocity time series.
Specifically, it is used to smooth:
\itemize{
\item Vertical velocity, after it is calculated from the central difference of smoothed depth values.
\item Swimming speed estimated from paddle wheel rotation frequencies (if \code{calculate.paddle.speed = TRUE}).
}
Smoothing is performed using an arithmetic moving average. Set to \code{NULL} to disable. Default: 1 second.}

\item{calculate.paddle.speed}{Logical. If TRUE and the tag was equipped with a paddle wheel,
estimates animal speed based on paddle wheel rotation frequency. Default is FALSE.}

\item{speed.calibration.values}{A data.frame containing paddle wheel calibration values for speed estimation.
Must contain at least three columns:
\itemize{
\item \code{year}: The year the calibration was performed (integer)
\item \code{package_id}: The package identifier matching the tag's attribute (character)
\item \code{slope}: The calibration slope value (numeric)
}
This parameter is only used when \code{calculate.paddle.speed = TRUE}. Default is NULL.}

\item{burst.quantiles}{Numeric vector. Quantiles (0-1) to define burst swimming events based on acceleration thresholds.
Use NULL to disable burst detection. Defaults to c(0.95, 0.99) (95th and 99th percentiles).}

\item{return.data}{Logical. Controls whether the function returns the processed data
as a list in memory. When processing large or numerous datasets, set to \code{FALSE} to reduce
memory usage. Note that either \code{return.data} or \code{save.files} must be \code{TRUE}
(or both). Default is \code{TRUE}.}

\item{save.files}{Logical. If \code{TRUE}, the processed data for each ID will be saved as RDS files
during the iteration process. This ensures that progress is saved incrementally, which can
help prevent data loss if the process is interrupted or stops midway. Default is \code{FALSE}.}

\item{output.folder}{Character. Path to the folder where the processed files will be saved.
This parameter is only used if \code{save.files = TRUE}. If \code{NULL}, the RDS file will be saved
in the data folder corresponding to each ID. Default is \code{NULL}.}

\item{output.suffix}{Character. A suffix to append to the file name when saving.
This parameter is only used if \code{save.files = TRUE}.}

\item{data.table.threads}{Integer or NULL. Specifies the number of threads
that data.table should use for parallelized operations. NULL (default): Uses data.table's current default threading.
Notes:
\itemize{
\item Optimal thread count depends on your CPU cores and data size
\item More threads use more RAM but can significantly speed up large operations
\item Can be permanently set via \code{data.table::setDTthreads()}
\item Current thread count: \code{data.table::getDTthreads()}
}}

\item{verbose}{Logical. If TRUE, the function will print detailed processing information. Defaults to TRUE.}
}
\value{
If \code{return.data = TRUE}, returns a list where each element contains the
processed sensor data for an individual folder. If \code{return.data = FALSE},
returns \code{NULL} invisibly. In all cases, data will be saved to disk if
\code{save.files = TRUE}.
}
\description{
This function processes high-resolution archival tag data, automatically computing a
wide range of kinematic and orientation metrics from accelerometer, magnetometer,
and gyroscope signals (see the \emph{Details} section below for a complete list).

Orientation is estimated by default using the tilt-compensated compass method, which fuses accelerometer
and magnetometer data to determine body orientation relative to gravity and magnetic north.
Optionally, a more advanced sensor fusion approach using the Madgwick filter can be applied.

A full 3D magnetic calibration can be applied prior to orientation estimation, including both
hard iron (offset) and soft iron (scaling and misalignment) corrections.

For tags equipped with a magnetic paddle wheel, the function can also estimate swimming speed.
This is achieved by extracting the dominant rotation frequency from the magnetometer's
z-axis signal using a Fast Fourier Transform (FFT), which is then converted
to speed using a tag-specific calibration slope

After metric computation, the data can be downsampled to reduce its resolution and
size for downstream analysis.

Note: Python and the associated libraries \code{AHRS} and \code{numpy} (accessible via \code{reticulate}) are required
if orientation is estimated using the Madgwick filter.
}
\details{
This function computes a suite of movement and orientation metrics from high-frequency tri-axial sensor data,
including acceleration, orientation, and linear motion parameters. It also performs automatic magnetic calibration
to improve heading estimation.

\strong{Acceleration:}
\itemize{
\item Total Acceleration (g): The total magnitude of the animal's acceleration, calculated from the three orthogonal accelerometer components.
\item Vectorial Dynamic Body Acceleration (VeDBA) (g): Quantifies the physical acceleration of the animal, calculated as the vector magnitude of the dynamic body acceleration, which is the difference between raw accelerometer data and the moving average (static acceleration).
\item Overall Dynamic Body Acceleration (ODBA) (g): A scalar measure of the animal's overall acceleration, calculated as the sum of the absolute values of the dynamic acceleration components along the X, Y, and Z axes.
\item Burst Swimming Events: Identifies periods of high acceleration based on a given acceleration magnitude percentile, which can be used to detect burst swimming behavior. This metric is binary, indicating whether the acceleration exceeds the threshold.
}

\strong{Orientation:}

Computed using sensor fusion algorithms:
\itemize{
\item {Tilt-compensated compass} (default): A lightweight 6-axis fusion (accelerometer + magnetometer)
to compute roll, pitch, and heading. The method first calculates tilt angles from accelerometer data,
then compensates the magnetometer readings using these angles to compute a more accurate heading
(as described in Gunner et al., 2021). This approach avoids gyroscope drift but may be affected by magnetic disturbances.
\item {Madgwick filter}: A 9-axis fusion algorithm (accelerometer + gyroscope + magnetometer)
implementing Sebastian Madgwick's quaternion-based gradient descent
approach. This provides absolute orientation reference by incorporating
Earth's magnetic field and is more robust to transient disturbances,
at the cost of higher computational complexity.
}
Output includes:
\itemize{
\item Roll (degrees): Rotational movement of the animal around its longitudinal (x) axis.
\item Pitch (degrees): Rotational movement of the animal around its lateral (y) axis.
\item Heading (degrees): Directional orientation of the animal, representing the compass heading.
Heading is corrected based on the deployment coordinates using global geomagnetic declination models.
\item Turning Angle (degrees): The change in heading between consecutive time points, representing the animal's turning behaviour. Calculated as the minimum angular difference between consecutive headings, constrained between –180° and 180°.
}

\strong{Linear Motion:}
\itemize{
\item Surge (g): The forward-backward linear movement of the animal along its body axis, derived from the accelerometer data.
\item Sway (g): The side-to-side linear movement along the lateral axis of the animal, also derived from the accelerometer data.
\item Heave (g): The vertical linear movement of the animal along the vertical axis, estimated from accelerometer data.
\item Vertical Velocity (m/s): The rate of change in the animal’s depth over time, including direction (positive for descent, negative for ascent).
Vertical velocity is calculated using a central difference method on the smoothed depth time series (with smoothing controlled by \code{depth.smoothing}).
An optional secondary smoothing step can be applied to the resulting velocity time series (see \code{speed.smoothing}).
}

\strong{Python Requirements}
\itemize{
\item Requires the \code{reticulate} R package for interfacing with Python.
\item The active Python environment must include the \code{AHRS} and \code{numpy} modules.
\item If unavailable, the function will return an informative error with installation guidance.
}
}
\references{
Gunner RM, Holton MD, Scantlebury MD, \emph{et al.} (2021) Dead-reckoning animal
movements in R: a reappraisal using Gundog. \emph{Animal Biotelemetry}. 9:1–37.
\doi{10.1186/s40317-021-00245-z}

Kawatsu S, Sato K, Watanabe Y, Hyodo S, Breves JP, Fox BK, \emph{et al.} (2009).
A new method to calibrate attachment angles of data loggers in swimming sharks.
\emph{EURASIP Journal on Advances in Signal Processing}. 2010, 732586.
\doi{10.1155/2010/732586}
}
\seealso{
\link{importTagData}, \link{filterDeploymentData}.
}
